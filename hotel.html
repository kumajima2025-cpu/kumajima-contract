<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>熊嶼｜住宿前資料表（含簽名）</title>
  <style>
    :root { --bg:#fff; --card:#faf7f2; --line:#e7dfd2; --text:#2b2b2b; --muted:#6b6b6b; }
    body{font-family: -apple-system,BlinkMacSystemFont,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      margin:0; background:var(--bg); color:var(--text);}
    .wrap{max-width:860px; margin:0 auto; padding:18px;}
    h1{font-size:20px; margin:10px 0 6px;}
    .hint{color:var(--muted); font-size:13px; margin-bottom:14px; line-height:1.5;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin:12px 0;}
    .secTitle{font-weight:700; margin-bottom:10px;}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
    @media (max-width:720px){ .grid,.grid3{grid-template-columns:1fr;} }
    label{display:block; font-size:13px; margin:2px 0 6px;}
    input,select,textarea{
      width:100%; box-sizing:border-box; padding:10px 10px; border-radius:10px;
      border:1px solid var(--line); background:#fff; font-size:15px;
    }
    textarea{min-height:90px; resize:vertical;}
    .row{display:flex; gap:12px; flex-wrap:wrap;}
    .chip{display:flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--line);
      border-radius:999px; background:#fff; font-size:14px;}
    .chip input{width:auto;}
    .small{font-size:12px; color:var(--muted);}
    .sigBox{background:#fff; border:1px dashed #cdbfae; border-radius:12px; padding:10px;}
    canvas{width:100%; height:180px; border:1px solid var(--line); border-radius:10px; touch-action:none;}
    .btns{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    button{
      padding:10px 14px; border:0; border-radius:12px; cursor:pointer; font-size:15px;
    }
    .primary{background:#2b2b2b; color:#fff;}
    .ghost{background:#fff; border:1px solid var(--line);}
    .footer{margin:14px 0 24px; font-size:12px; color:var(--muted); line-height:1.5;}
    .status{margin-top:10px; font-size:14px;}
    .ok{color:#1b7f3a;}
    .bad{color:#b00020;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>住宿前資料表（含簽名）</h1>
    <div class="hint">
      請於住宿前填寫完成。送出後，系統會產生 PDF 並寄送到店家（可選擇同時寄一份到您的 Email）。
      <br/>※ 星號為必填
    </div>

    <div class="card">
      <div class="secTitle">飼主資料</div>
      <div class="grid">
        <div>
          <label>主要聯絡人姓名 *</label>
          <input id="owner_name" placeholder="例：王小明" required />
        </div>
        <div>
          <label>手機 *</label>
          <input id="owner_phone" inputmode="tel" placeholder="09xxxxxxxx" required />
        </div>
        <div>
          <label>Email（收副本用）</label>
          <input id="owner_email" inputmode="email" placeholder="you@example.com" />
          <div class="small">不填也可以（店家仍會收到 PDF）</div>
        </div>
        <div>
          <label>現居地址（選填）</label>
          <input id="owner_address" placeholder="縣市／區／路／號（可留空）" />
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="secTitle">備用聯絡人（緊急聯絡）</div>
      <div class="grid">
        <div>
          <label>備用聯絡人姓名</label>
          <input id="backup_name" placeholder="例：李小姐" />
        </div>
        <div>
          <label>備用聯絡人手機</label>
          <input id="backup_phone" inputmode="tel" placeholder="09xxxxxxxx" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="secTitle">寵物資料</div>
      <div class="grid3">
        <div>
          <label>名字 *</label>
          <input id="pet_name" placeholder="例：豆豆" required />
        </div>
        <div>
          <label>性別 *</label>
          <select id="pet_sex" required>
            <option value="">請選擇</option>
            <option>公</option>
            <option>母</option>
          </select>
        </div>
        <div>
          <label>品種 *</label>
          <input id="pet_breed" placeholder="例：比熊" required />
        </div>
        <div>
          <label>出生年份（選填）</label>
          <input id="pet_birth_year" inputmode="numeric" placeholder="例：2022" />
        </div>
        <div>
          <label>是否已絕育</label>
          <select id="pet_neutered">
            <option value="">請選擇</option>
            <option>已絕育</option>
            <option>未絕育</option>
          </select>
        </div>
        <div>
          <label>體外驅蟲（選填）</label>
          <select id="pet_deworm">
            <option value="">請選擇</option>
            <option>滴劑</option>
            <option>口服</option>
            <option>無</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="grid">
        <div>
          <label>晶片號碼（選填）</label>
          <input id="pet_chip" placeholder="例：900xxxxxxx（可留空）" />
        </div>
        <div>
          <label>狂犬疫苗注射時間（選填）</label>
          <input id="pet_rabies" placeholder="例：2023/06" />
        </div>
      </div>

      <div style="height:10px"></div>
      <label>特殊疾病 / 舊疾（可複選）</label>
      <div class="row" id="disease_row">
        <label class="chip"><input type="checkbox" value="心臟病">心臟病</label>
        <label class="chip"><input type="checkbox" value="氣喘">氣喘</label>
        <label class="chip"><input type="checkbox" value="氣管塌陷">氣管塌陷</label>
        <label class="chip"><input type="checkbox" value="癲癇">癲癇</label>
        <label class="chip"><input type="checkbox" value="白內障">白內障</label>
        <label class="chip"><input type="checkbox" value="骨折">骨折</label>
        <label class="chip"><input type="checkbox" value="關節問題">關節問題</label>
        <label class="chip"><input type="checkbox" value="糖尿病">糖尿病</label>
      </div>
      <div class="grid">
        <div>
          <label>手術外傷尚未癒合（選填）</label>
          <input id="pet_wound" placeholder="例：左後腳手術傷口" />
        </div>
        <div>
          <label>其他（選填）</label>
          <input id="pet_other_disease" placeholder="例：皮膚過敏、腸胃敏感..." />
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="grid">
        <div>
          <label>配合動物醫院 / 醫師（選填）</label>
          <input id="vet" placeholder="例：XXX動物醫院" />
        </div>
        <div>
          <label>緊急情況授權（必選）*</label>
          <select id="emergency_consent" required>
            <option value="">請選擇</option>
            <option value="同意">同意店家緊急送醫並先行必要處置</option>
            <option value="不同意">不同意（請於備註說明處理方式）</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>
      <label>住宿備註（飲食、藥物、分離焦慮、注意事項等）</label>
      <textarea id="note" placeholder="例：早晚各半杯飼料；會吃藥；怕生；不與陌生狗互動..."></textarea>
    </div>

    <div class="card">
      <div class="secTitle">飼主簽名 *</div>
      <div class="sigBox">
        <div class="small">請在下方簽名（手指或觸控筆皆可）。</div>
        <canvas id="sig"></canvas>
        <div class="btns">
          <button class="ghost" id="clearBtn" type="button">清除簽名</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="grid">
        <div>
          <label>簽名日期 *</label>
          <input id="signed_date" />
        </div>
        <div>
          <label>送出後 PDF 寄送</label>
          <div class="small">店家一定會收到；若上方有填 Email，系統也會寄一份副本給您。</div>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="submitBtn" type="button">送出表單</button>
      </div>
      <div class="status" id="status"></div>
    </div>

    <div class="footer">
      送出即表示您所填資料為真，並同意住宿期間店家依照安全與衛生原則進行照護。如遇緊急狀況，依您勾選之授權處理。
    </div>
  </div>

<script>
  // ✅ 你的 GAS Web App URL（部署後貼在這裡）
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxqGClusR1snhEVc-lbtAhrPoQOIxRQ2FLcfPj37Y8qTNDlq6tIShIcXyd1VCX3bivs/exec";

  // 讓日期預設今天
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  document.getElementById("signed_date").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  // --- 簽名板 ---
  const canvas = document.getElementById('sig');
  const ctx = canvas.getContext('2d');
  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = Math.floor(rect.width * ratio);
    canvas.height = Math.floor(rect.height * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#111';
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  let drawing = false;
  let last = null;

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : null;
    const clientX = touch ? touch.clientX : e.clientX;
    const clientY = touch ? touch.clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  }

  function start(e){
    e.preventDefault();
    drawing = true;
    last = getPos(e);
  }
  function move(e){
    if(!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    last = p;
  }
  function end(e){
    if(!drawing) return;
    e.preventDefault();
    drawing = false;
    last = null;
  }

  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  window.addEventListener('mouseup', end);

  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove', move, {passive:false});
  canvas.addEventListener('touchend', end, {passive:false});

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
  });

  function canvasIsBlank(){
    const blank = document.createElement('canvas');
    blank.width = canvas.width; blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
  }

  function checkedDiseases(){
    return [...document.querySelectorAll('#disease_row input[type="checkbox"]:checked')].map(x=>x.value);
  }

  function val(id){ return document.getElementById(id).value.trim(); }

  function setStatus(msg, ok=false){
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = "status " + (ok ? "ok":"bad");
  }

  document.getElementById('submitBtn').addEventListener('click', async ()=>{
    try{
      // 基本驗證
      const required = [
        ["owner_name","請填主要聯絡人姓名"],
        ["owner_phone","請填手機"],
        ["pet_name","請填寵物名字"],
        ["pet_sex","請選擇性別"],
        ["pet_breed","請填品種"],
        ["emergency_consent","請選擇緊急情況授權"],
        ["signed_date","請填簽名日期"],
      ];
      for(const [id,msg] of required){
        if(!val(id)){ setStatus(msg); return; }
      }
      if(canvasIsBlank()){ setStatus("請先簽名"); return; }

      setStatus("送出中…請稍候");

      const payload = {
        action: "submitHotelIntake",
        data: {
          owner_name: val("owner_name"),
          owner_phone: val("owner_phone"),
          owner_email: val("owner_email"),
          owner_address: val("owner_address"),
          backup_name: val("backup_name"),
          backup_phone: val("backup_phone"),

          pet_name: val("pet_name"),
          pet_sex: val("pet_sex"),
          pet_breed: val("pet_breed"),
          pet_birth_year: val("pet_birth_year"),
          pet_neutered: val("pet_neutered"),
          pet_deworm: val("pet_deworm"),
          pet_chip: val("pet_chip"),
          pet_rabies: val("pet_rabies"),
          pet_diseases: checkedDiseases(),
          pet_wound: val("pet_wound"),
          pet_other_disease: val("pet_other_disease"),
          vet: val("vet"),
          emergency_consent: val("emergency_consent"),
          note: val("note"),

          signed_date: val("signed_date"),
          signature_png: canvas.toDataURL("image/png"),
          ua: navigator.userAgent,
          created_at: new Date().toISOString()
        }
      };

      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: {"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      if(!json.ok){
        setStatus("送出失敗：" + (json.error || "未知錯誤"));
        return;
      }
      setStatus("✅ 已送出！PDF 將寄到店家（若有填 Email 也會寄一份給您）", true);

      // 可選：送出後鎖按鈕
      document.getElementById('submitBtn').disabled = true;

    }catch(err){
      setStatus("送出失敗：" + err.message);
    }
  });
</script>
</body>
</html>
