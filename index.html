<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>熊嶼｜犬貓美容服務契約簽署</title>

  <!-- ✅ LIFF SDK 一定要在你自己的 JS 之前 -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f6f6f6;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    h1 {
      font-size: 20px;
      margin: 0 0 6px;
    }
    .hint {
      font-size: 13px;
      color: #666;
    }
    .contract {
      margin-top: 12px;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 12px;
      height: 260px;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: break-word;
      line-height: 1.6;
      font-size: 14px;
      background: #fafafa;
    }
    label {
      display: block;
      font-weight: 600;
      margin: 12px 0 6px;
      font-size: 14px;
    }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
      box-sizing: border-box;
    }
    canvas {
      width: 100%;
      height: 180px;
      border: 1px solid #ccc;
      border-radius: 12px;
      background: #fff;
      touch-action: none;
    }
    button {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-main {
      background: #111;
      color: #fff;
      margin-top: 12px;
    }
    .btn-sub {
      background: #eee;
      margin-top: 8px;
    }
    #status{
      text-align:center;
      color:#d00;
      font-weight:700;
      margin-top:10px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

  <div class="card">
    <h1>熊嶼｜犬、貓美容服務定型化契約</h1>
    <div class="hint">
      公司名稱：熊嶼寵物有限公司<br>
      地址：新北市板橋區合宜一路11號
    </div>
  </div>

  <div class="card">
    <label>契約內容（請完整閱讀）</label>
    <div class="contract">
為了保障毛孩的安全與您的權益，本店採用犬、貓美容服務定型化契約。
請您在簽署前，花一點時間完整閱讀以下內容。

本契約主要說明雙方的權利與義務，以及服務過程中可能涉及的重要事項。
另有一份「犬、貓美容服務簽約前詢問事項及基本資料表」，將於服務前或到店時填寫，
作為我們了解毛孩個性、健康狀況與照護需求的重要依據，該資料亦屬本契約之一部分。

若您對內容有任何疑問，歡迎隨時向我們詢問，
我們很樂意為您說明，並與您一起為毛孩提供最安心的照護。

犬、貓美容服務定型化契約
（以下略：你的完整契約內容保持不變，已省略顯示避免太長；請你把原本完整契約文字貼回這裡）
    </div>

    <label style="margin-top:12px;">
      <input type="checkbox" id="agree" style="width:auto; margin-right:6px;">
      我已完整閱讀並同意上述契約內容
    </label>
  </div>

  <div class="card">
    <h1>甲方資料填寫</h1>
    <p class="hint">請填寫以下資料以完成契約簽署</p>

    <label>甲方姓名（消費者）</label>
    <input type="text" id="customerName" placeholder="請輸入姓名" />

    <label>聯絡電話</label>
    <input type="tel" id="phone" placeholder="請輸入聯絡電話" />

    <label>身分證字號</label>
    <input type="text" id="idNumber" placeholder="請輸入身分證字號" />

    <label>通訊地址</label>
    <input type="text" id="address" placeholder="請輸入通訊地址" />

    <label>寵物名字</label>
    <input type="text" id="petName" placeholder="請輸入寵物名字" />

    <label>品種</label>
    <input type="text" id="breed" placeholder="例：比熊犬" />

    <label>體重（公斤）</label>
    <input type="number" id="weight" placeholder="例：6.5" step="0.1" />

    <label>審閱／簽署日期</label>
    <input type="date" id="signDate" />
  </div>

  <div class="card">
    <label>甲方簽名</label>
    <canvas id="sig"></canvas>

    <p class="hint" style="margin-top:8px; font-weight:700; color:#d00;">
      簽名完成後請點「送出簽署」，系統將自動回傳資料與簽名紀錄至本 LINE 對話。
    </p>

    <button class="btn-main" id="submitAll">送出簽署</button>
    <button class="btn-sub" id="clear">清除簽名</button>

    <p id="status"></p>
    <button class="btn-sub" id="closeBtn" style="display:none;">關閉視窗</button>
  </div>

  <script>
  (function () {
    /* ========= 你的設定 ========= */
    const LIFF_ID = "2008805180-dNJmIam4";
    const SUBMIT_ENDPOINT = "https://script.google.com/macros/s/AKfycbykw5In_C7DIZuLIQiNt4UrKGgSKbAQfKrZMZHlYoH3dqp7kMLvyZKcqmRj1InMPSbcHQ/exec";
    const SECRET = "KUMAJIMA_SECRET_2026";

    const status = document.getElementById("status");
    const closeBtn = document.getElementById("closeBtn");
    const submitBtn = document.getElementById("submitAll");
    const clearBtn = document.getElementById("clear");
    const agree = document.getElementById("agree");

    function setStatus(text, ok=false) {
      status.style.color = ok ? "#111" : "#d00";
      status.textContent = text;
    }

    /* ========= 簽名 ========= */
    const canvas = document.getElementById("sig");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    let hasStroke = false;

    function resizeCanvas() {
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#111";
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    function getPos(e) {
      const r = canvas.getBoundingClientRect();
      const t = e.touches ? e.touches[0] : e;
      return { x: t.clientX - r.left, y: t.clientY - r.top };
    }
    function start(e) {
      e.preventDefault();
      drawing = true;
      const p = getPos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }
    function move(e) {
      if (!drawing) return;
      e.preventDefault();
      const p = getPos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      hasStroke = true;
    }
    function end() { drawing = false; }

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", move);
    canvas.addEventListener("mouseup", end);
    canvas.addEventListener("mouseleave", end);
    canvas.addEventListener("touchstart", start, { passive: false });
    canvas.addEventListener("touchmove", move, { passive: false });
    canvas.addEventListener("touchend", end, { passive: false });

    clearBtn.addEventListener("click", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasStroke = false;
      setStatus("已清除簽名");
    });

    /* ========= LIFF 初始化 ========= */
    let liffReady = false;

    async function init() {
      try {
        if (typeof liff === "undefined") {
          setStatus("❌ LIFF SDK 未載入（請檢查 head 的 SDK script）");
          return;
        }
        setStatus("初始化中…");
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;

        if (!liff.isInClient()) {
          setStatus("⚠️ 請在 LINE 官方帳號內開啟此頁面（LIFF）");
          return;
        }
        setStatus("✅ 可開始填寫並簽名", true);
      } catch (e) {
        console.error(e);
        setStatus("初始化失敗（LIFF）： " + (e?.message || e), false);
      }
    }
    init();

    function v(id) {
      return (document.getElementById(id)?.value || "").trim();
    }

    /* ========= 送出：上傳簽名→回傳URL→送到聊天室 ========= */
    submitBtn.addEventListener("click", async () => {
      // ✅ 第一時間就顯示，保證你看得到「有反應」
      setStatus("✅ 已點擊送出（開始處理…）", true);

      try {
        if (!agree.checked) {
          setStatus("請先勾選：我已完整閱讀並同意契約內容");
          return;
        }
        if (!liffReady) {
          setStatus("LIFF 尚未初始化完成，請稍等 1 秒再試");
          return;
        }
        if (!liff.isInClient()) {
          setStatus("請在 LINE 內開啟此頁面後再送出");
          return;
        }
        if (!hasStroke) {
          setStatus("請先在簽名框簽名");
          return;
        }

        const name = v("customerName");
        const phone = v("phone");
        const signDate = v("signDate");
        if (!name || !phone || !signDate) {
          setStatus("請填寫：姓名 / 聯絡電話 / 審閱／簽署日期");
          return;
        }

        submitBtn.disabled = true;
        setStatus("上傳簽名中…");

        const payload = {
          secret: SECRET,
          customerName: name,
          phone: phone,
          idNumber: v("idNumber"),
          address: v("address"),
          petName: v("petName"),
          breed: v("breed"),
          weight: v("weight"),
          signDate: signDate,
          signature: canvas.toDataURL("image/png")
        };

        const res = await fetch(SUBMIT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const out = await res.json();
        if (!out.ok || !out.imageUrl) throw new Error(out.error || "Upload failed");

        setStatus("傳送到 LINE 中…");

        const text =
`【犬貓美容契約簽署資料】
甲方姓名：${payload.customerName}
聯絡電話：${payload.phone}
身分證字號：${payload.idNumber}
通訊地址：${payload.address}
寵物名字：${payload.petName}
品種：${payload.breed}
體重(公斤)：${payload.weight}
審閱／簽署日期：${payload.signDate}`;

        await liff.sendMessages([
          { type: "text", text },
          { type: "image", originalContentUrl: out.imageUrl, previewImageUrl: out.imageUrl }
        ]);

        setStatus("✅ 已完成回傳（資料＋簽名）！", true);

        closeBtn.style.display = "block";
        closeBtn.onclick = () => liff.closeWindow();

      } catch (e) {
        console.error(e);
        setStatus("送出失敗：" + (e?.message || "請檢查網路或 Apps Script 部署權限"));
        submitBtn.disabled = false;
      }
    });
  })();
  </script>

</body>
</html>

